\documentclass[12pt,oneside]{article}
\usepackage{url}
\usepackage{arabtex} % Arabic support
\usepackage{mathtools} % Math :)

\usepackage{semtrans}
\usepackage[english]{babel}               % shorthands

\usepackage[marginparwidth=2in, top=1.5in, bottom=1.5in, left=1.5in, right=1.5in]{geometry} % margin=1.5in

\usepackage{setspace}
\singlespacing
%\onehalfspacing
%\setstretch{1.6} % doublespacing everywhere, except footnotes

\usepackage{fixltx2e} % support of \textsubscript & \textsuperscript
\usepackage{xspace} % adds a space after autocorrected word

\usepackage{graphicx} % Needed to insert images into the document
\graphicspath{{graphics/}} % Sets the default location of pictures

\include{autocorrect}
\include{extrafunctions}

\newcommand\abbreviation[1]{\textbf{#1}}                        %ABBR  sources abbreviated
\newcommand\adjective[1]{#1}                      %ADJ   different adjectives, names
\newcommand\computer[1] {\texttt{#1}}   %COMP  anything computer related
\newcommand\database[1] {\textsc{#1}}   %DB    names of DBs, digital libraries, websites
\newcommand\community[1]    {#1}          %GR    social groups, sects, dynasties, legal schools, families
\newcommand\toponym[1] {#1}                           %TOP   toponyms --- transliterated place names
\newcommand\location[1] {#1}                      %LOC   locations --- English spelling
\newcommand\person[1]   {#1}                      %PERS  name of an actual person, author, like Ibn al-Jawzi
\newcommand\source[1]   {\textsl{#1}}   %SRC   book, medieval sources
\newcommand\term[1]     {\textit{#1}}   %TERM  any Arabic terms that must by italicized
\newcommand\misc[1]     {{#1}}            %MISC  for any other unclassified, including abbreviations
\newcommand\arQuote[1]     {\textsc{\textit{#1}}}                     %MISC  for any other unclassified, including abbreviations


% DIACRITICS %
\useshorthands{"} % for letters with DOTS beneath (consonants) and UMLAUTS (vowels)
\defineshorthand{"t}{{\d t}}
\defineshorthand{"T}{{\d T}}
\defineshorthand{"s}{{\d s}}
\defineshorthand{"S}{{\d S}}
\defineshorthand{"d}{{\d d}}
\defineshorthand{"D}{{\d D}}
\defineshorthand{"h}{{\d h}}
\defineshorthand{"H}{{\d H}}
\defineshorthand{"k}{{\d k}}
\defineshorthand{"K}{{\d K}}
\defineshorthand{"z}{{\d z}}
\defineshorthand{"Z}{{\d Z}}

%\defineshorthand{"A}{{\" A}}
%\defineshorthand{"a}{{\" a}}
%\defineshorthand{"U}{{\" U}}
%\defineshorthand{"u}{{\" u}}
%\defineshorthand{"E}{{\" E}}
%\defineshorthand{"e}{{\" e}}
%\defineshorthand{"O}{{\" O}}
%\defineshorthand{"o}{{\" o}}

%\useshorthands{~} % tilda conflicts with LaTeX during compilation!!! therefore replaced with "
\defineshorthand{"y}{{\' a}} % alif maqsura
\defineshorthand{"o}{{\' a}} % alif maqsura
\defineshorthand{"e}{{\= e}}
\defineshorthand{"a}{{\= a}}
\defineshorthand{"A}{{\= A}}
\defineshorthand{"u}{{\= u}}
\defineshorthand{"U}{{\= U}}
\defineshorthand{"i}{{\= \i}}
\defineshorthand{"I}{{\= \I}}

% `Ayns and Hamzas
\defineshorthand{"`}{\Ayn }
\defineshorthand{"'}{\Alif }

\def\and{\textit{\&}\xspace}

\usepackage{hyperref}
%\usepackage[document]{ragged2e} % entire document has ragged right

\usepackage[usenames,dvipsnames]{color}

\hypersetup{
  colorlinks,
  citecolor=blue,
  linkcolor=blue,
  urlcolor=blue}

\newcommand{\super}[1]{\textsuperscript{#1}}
\def\and{\textit{\&}\xspace}

\usepackage{fancyhdr}
\usepackage[yyyymmdd,hhmmss]{datetime}
\pagestyle{fancy}
\lhead{\textsc{QGIS Practicum}}
\chead{}
\rhead{\textbf{Version: \today\ @ \currenttime}}
\lfoot{\textsc{Mapping the Classical Islamic World}, Tufts U Spring 2014}
\cfoot{}
\rfoot{\textbf{Page \thepage}}

\begin{document}

% the beginning of the main text 

\begin{flushright}
\begin{footnotesize}
``Mapping the Classical Islamic World''\\
Maxim Romanov, Department of Classics\\
Tufts University, Spring 2014\\
\end{footnotesize}
\end{flushright}

\begin{center}
\begin{Large}
\textsc{QGIS: Something More Complex}
\end{Large}
\end{center}

\section{Starting Up}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Download and install \QGIS from \href{http://www.qgis.org/en/site/forusers/download.html}{www.qgis.org}. On the Download page select the version for your system. \QGIS is an Open Source Geographic Information System (GIS) licensed under the GNU General Public License. The latest release is \textbf{QGIS 2.0 Dufour}. \textbf{NB:} Also see an introduction @ ``Programming Historian'' (\href{http://programminghistorian.org/lessons/qgis-layers}{programminghistorian.org/lessons/qgis-layers}).

\begin{description}
\item[Win]If you are using a Windows computer, select \textbf{QGIS Standalone Installer Version x.x (XX bit)} (current latest version is Version 2.2 Valmiera). Since most computers now run 64-bit operational system, you should select a 64-bit version. Yet, it is worth checking what system is installed on your computer (try \texttt{Control Panel~/ System and Security~/ System}, check ``System type'').

\item[Mac]If you are running a Mac, you will need to follow the link given in \texttt{Download for Mac OS X} section (\href{http://www.kyngchaos.com/software/qgis}{KyngChaos QGIS download page}) and install all the dependencies. This may take a little while, but \QGIS should get installed without major issues: essentially, the system will tell you what is missing, you will need to download the missing package, or module and install it in order to continue. All required dependencies are available at the \texttt{KyngChaos QGIS download page}.

\item[$\rightarrow$] After surviving nine circles of hell (aka ``installation''), Mac users will need to install and activate some useful plugins: in \texttt{Plugins} menu, select \includegraphics[scale=.75]{qgis_plugins} (\texttt{Manage and Install Plugins}); some of the plugins that we'll need are already installed and they only need to be activated, while others have to be installed. You need the following three:\\
\textbullet~Coordinate Capture (\includegraphics[scale=.5]{qgis_capture})\\
\textbullet~Georeferencer (\includegraphics[scale=.5]{qgis_georeferencer})\\
\textbullet~Open Layers (\includegraphics[scale=.5]{qgis_openlayers})\\


\end{description}


\section{Georeferencing: Basic Ideas}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
In a nutshell, georeferencing means\footnote{Feel free to check the following resources for more detailed explanations on \href{http://en.wikipedia.org/wiki/Georeference}{Wikipedia} and on \href{http://webhelp.esri.com/arcgisdesktop/9.2/index.cfm?TopicName=Georeferencing_a_raster_dataset}{ESRI.com}, the website of the developers of ArcGIS.} defining the location of some object in physical space. In our case, we will be fitting historical maps onto the system of geographical coordinates by creating spacial references within a geodetic reference system. In plain English this means that we will be assigning specific geographical coordinates to specific points on our maps. Using these data, \QGIS will transform the image of a map in such a way that we will be able to collect all necessary information from our analog maps, converting it into a digital dataset, which will allow us to create a cumulative dynamic digital map.

\section{Georeferencing, one step at a time...}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
We will start with fitting historical maps onto the system of geographical coordinates by creating spacial references within a geodetic reference system. \textbf{NB:} a number of manuals on georeferencing with \QGIS are available online. A very detailed one is available at ``Programming Historian'' (\href{http://programminghistorian.org/lessons/georeferencing-qgis}{programminghistorian.org/lessons/georeferencing-qgis}).

\begin{enumerate}

\item Open \QGIS \textbf{Desktop} (whatever version you have installed; the current one is \QGIS \textbf{2.2.0-Valmiera})

\item In the main menu, open \texttt{Raster}, then find and open \texttt{Georeferencer}. \textbf{NB}: if it is not there, you may have to install this plugin (\texttt{Plugins > Manage and Install Plugins...})

\item In the \texttt{Georeferencer} window, \includegraphics[scale=.5]{qgis_g_openraster} \texttt{Open raster} (\textbf{NB}: you can open it with a \includegraphics[scale=.5]{qgis_g_openraster} button; or through the main menu: \texttt{File > Open Raster}; or using a shortcut \texttt{Ctrl+o}). In the \texttt{Open raster} window, navigate to a folder where you stored all your maps and select the one that you want to georeference.\\
\textbf{NB:} I strongly recommend to create a separate folder for your maps and keep all the files that will be produced with \QGIS in this very folder. Trust me, it will make your life easier, especially when you work with many maps.

\item After you select your map, a \texttt{Coordinate Reference System Selector} will open. Here you need to select a projection~/ geographic coordinate system. In the ideal world, one can find this crucial piece of information somewhere on the margins of a map. Knowing proper projection makes georeferencing easier and more precise. Unfortunately, as is the case with most historical maps, our maps lack this crucial piece of information. Fortunately, our maps have a consistent coordinate grid with latitudes and longitudes given on the margins. In our case we need \textbf{WGS 84}. Click \texttt{Ok} when you are done. You should now see the image of a map opened in \textbf{Georeferencer}.

\item It may be convenient to open \texttt{GCP Table} (\texttt{View > Panels > GCP table}), which will show \textit{ground control points} that you will be adding.

\item Since \QGIS is not particularly snappy when it comes to panning high-resolution images, it may be convenient to open the same map in some image viewer on your computer. You will find it easier to navigate when you need to check latitudes and longitudes that are given on margins.

\item \includegraphics[scale=.5]{qgis_g_zoomin} Zoom in so that you can clearly see the coordinate grid and its crossing points. Check the coordinates of your first point (start from some corner); then select \includegraphics[scale=.5]{qgis_g_addpoint} and click on your first point (using mouse is much easier).

\item You will be prompted to enter map coordinates. Enter your longitude (\texttt{X/East}) and latitude (\texttt{Y/North}). On the image below the coordinates of the point are 48$^{\circ}$E,~31$^{\circ}$N. Click \texttt{Ok} when you are done.\\
\includegraphics[scale=.5]{qgis_g_entermapcoordinates}\\
\textbf{NB:} If your coordinates are in western/southern part of the globe, use \textbf{minus} sign in front of your values.

\item Now the fun part: you need to repeat this procedure for all remaining crossing points of the grid with coordinates. Since we do not have projection~/ geographic coordinate system for our maps we need to georeference as many points as possible in order to improve the precision of our work.

\item After you finish georeferencing the grid and before you proceed to the next step, you need to check the placement of your \texttt{ground control points} (\textit{aka} small red dots that you have been adding). Zoom in to a point and make sure that the red dot is where it is supposed to be. If it is not, select \includegraphics[scale=.5]{qgis_g_movegcp}~\texttt{Move GCP Point}, and move the point to where it should be (it helps to start at some corner and keep checking the entire map consistently from there).

\item It is worth saving your work: click \includegraphics[scale=.5]{qgis_g_savegcp}~\texttt{Save GCP points}, and use the name of the file suggested by \QGIS (by default, it adds \texttt{.points} to the name of the map). In this case, if you open this map file again, \texttt{ground control points} will be automatically downloaded into \QGIS and you will be able to continue your work where you finished. Also, it is worth saving your GCP points periodically. Just in case.

\item Now we need to choose appropriate \includegraphics[scale=.5]{qgis_transformationsettings}~\texttt{Transformation Settings}, and make sure that the following settings are selected.\\
\textbullet~Transformation type: \texttt{Thin Plate Spline} (this transformation type deforms the map in such a way that all ground control points correspond to coordinates that you supplied)\\
\textbullet~Resampling method: \texttt{Nearest neighbour} (for our purposes it does not really matter what resampling method to use; use Google for more information about information on this issue).\\
\textbullet~Compression: \texttt{LZW} (this option affects the size of the produced \texttt{TIFF} image; if you select other option the size of the file will be larger)\\
\textbullet~Output raster: ... (let \QGIS suggest the name of the file, which will ensure consistent naming of your files. By default \QGIS adds suffix \texttt{\_modified} to the name of the map)\\
\textbullet~Target SRS: \texttt{EPSG:4326} (which corresponds to \textbf{WGS 84})\\
\textbullet~Check \texttt{Load in QGIS when done}.\\
\includegraphics[scale=.5]{qgis_transformationsettingstab}

\item Now you can run \texttt{Georeferencer}: click \includegraphics[scale=.5]{qgis_g_georeference} button. After the process is complete, your georeferenced map will appear in the main window of \QGIS. Minimize \texttt{Georeferencer}, and switch to the main \QGIS window.

\item In the main \QGIS window, run \texttt{Plugins > OpenLayers plugin > Add Google physical layer} (\includegraphics[scale=.5]{qgis_openlayersgphys}). This will add a Google map layer; make sure that your georeferenced map is on top of this new layer (you can drag-n-drop it, to change the order).

\item Right-click (Two-finger touch on \textbf{Mac}) on the layer with your georeferenced map to open context menu and run \texttt{Zoom to layer extent}. Now you should see you map overlayed on top of a physical Google map.

\item Double-click on the layer with your map will open \texttt{Layer properties}. On \texttt{Transparency} tab, change \texttt{Global transparency} to about 50\%. Click \texttt{Ok}.

\item Now your map is transparent and you can check how precise your georeferencing. Zoom in to different areas of the map and check if locations on you map correspond to those on Google map. Ideally, the results should be pretty good. On the image below you can see how a historical map is overlayed on top of Google physical map: Mosul/al-Maw"sil and Tal Afar/Tall A"`far, which are present on both maps, correspond very closely.\\
\includegraphics[scale=.5]{qgis_georeferencedmap}

\item Save your work in \QGIS: \texttt{Project > Save}. Do not forget to open this project when you georeference your next map!


\end{enumerate}

\section{No projection, no grid?}

It is very possible that you may have to georeference a map that has neither projection, nor coordinate grid. It is still possible to georeference such maps, although the quality of georeferencing will vary depending on a map. This process is rather similar to the one described above, but since we do not have coordinate grid we'll need to find anchor points that we can use instead: any feature existing on both maps can be an anchor spot---settlements, shorelines, lakes, etc. (although one should always be careful using water bodies as anchors, since they have a tendency to change their shape in the course of history).

\begin{enumerate}
\item 
\end{enumerate}

\section{Georeferencing: al-Muqaddas"i's Maps}

Earlier, working with \GoogleEarth you tried to fit al-Muqaddas"i's map over the modern globe. This was a pretty tough assignment, partially because of the nature of al-Muqaddas"i's map---which show relative positions of cities \visavis each other, rather than their absolute geographical locations---and partially because of the limitations of \GoogleEarth. Using the method describe in the previous section, we can georeference al-Muqaddasi maps more easily and more effectively.

As you remember, Google maps were not very helpful when you tried to overlay al-Muqaddas"i's maps. This was because modern maps lack most historical places. So, Openlayer plugin that loads Google physical map will not be helpful. Instead, we can use Cornu's georeferenced maps as a base layer for georeferencing.

\section{Collecting coordinates: creating basic data files}

...

\section{Running Python scripts}



\section{Testing your results}

Working with hundreds of data points, one needs a reliable way of tracking one's progress that will help to ensure that data collected properly and formatted appropriately. After you run \Python script (\texttt{gisTransformation.py}), it will generate files of several different formats. For testing your results you will need \texttt{.CSV} file, which you can load into \QGIS.

\begin{enumerate}

\item In \QGIS, in you working project (i.e., where your georeferenced Cornu maps are), go to \texttt{Layer > Add Text Delimited Layer...}

\item In \texttt{File Name}, click \texttt{Browse} and select your newly generated \texttt{.CSV} file. Click \texttt{Open}.

\item In \texttt{Create a Layer from a Delimited Text File} you need to select fields that contain geographical coordinates: In \texttt{X field} select \texttt{field\_3} (longitude), in \texttt{Y field} select \texttt{field\_4} (latitude).

\item in \texttt{Coordinate Reference System Selector}, choose WGS~84 (you need to select the system that corresponds to the system of your project). Click \texttt{Ok}.

\item Now you should see a series of dots at the places that you have already added to your initial \texttt{.TXT} file with coordinates. Although it is helpful, you cannot really see whether you typed the names of places correctly. Let's modify this new layer a little.

\item Open \texttt{Layer Properties} (\textbf{Win}: right-click~/ \textbf{Mac}: two-finger click on the layer, select \texttt{Properties}). Select \texttt{Layer} tab, and check \texttt{Label this layer with} and select the field that you want displayed (\texttt{field\_3} contains toponyms). Here you can also change properties of your labels: color, font type, font size, offset etc. Change label size so that they are easy to see. You may also want to choose a particular color (this will be particularly convenient when you have more than one layer of this kind). Click \texttt{Apply} to see how labels look like with your current properties. Click \texttt{Ok} when you are done.

\item In order to add another layer of this kind, just repeat the steps.

\item Now, when you do any changes to the original \texttt{.TXT} file and run the transformation script, you should see the changes automatically appearing in \QGIS (switch the layer off and then on in order to update it). This arrangement will help you to keep track of your work, make sure that you geotagged all places from the map, and that you transliterated them correctly.

\end{enumerate}

\section{Creating Routes}

We have collected coordinates for settlements of different kind (\textit{m\'etropole}, \textit{capitale}, \textit{cit\'e}, \textit{\'etape}) and other geographical features (regions, rivers, lakes, mountains, etc.). Our maps contain another valuable kind of data: trade routes (green lines, \textit{itin\'eraire}), but converting this information into a digital dataset requires a different, more complicated procedure. This is because, settlements and routes represent different geometries: settlements are points (at least in our current case), while routes are lines.

\begin{enumerate}

\item Create a new vector layer: \texttt{Layer > New > New Shapefile Layer...} (Shortcut: \texttt{Ctrl+Shift+N}) 

\item In the \texttt{New Vector Layer} window: select \texttt{Type > Line}; make sure that Coordinate Reference System (CRS) is WGS~84 (it should be: \textbf{EPSG:4326~-~WGS~84}); add the name of the layer (for convenience, use the name of the map + "\_Routes"). Click \texttt{Ok}.

\item In the open window, save your file (\QGIS will create a series of files). For convenience and consistency, use the same name as you did for the name of the layer, and save it to the same folder where your other map files are.

%http://geo.nls.uk/urbhist/guides_vectorlayerqgis.html



\end{enumerate}

\end{document}